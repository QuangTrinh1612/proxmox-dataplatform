---
- name: Setup MinIO Server on Debian LXC
  hosts: minio
  become: yes
  
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install required packages
      apt:
        name:
          - wget
          - curl
          - ca-certificates
          - gnupg
        state: present

    - name: Create MinIO user
      user:
        name: "{{ minio_service_user }}"
        system: yes
        shell: /bin/false
        home: "{{ minio_data_dir }}"
        createhome: no

    - name: Create MinIO directories
      file:
        path: "{{ item }}"
        state: directory
        owner: "{{ minio_service_user }}"
        group: "{{ minio_service_group }}"
        mode: '0755'
      loop:
        - "{{ minio_data_dir }}"
        - "{{ minio_config_dir }}"
        - "{{ minio_cert_path }}"

    - name: Download MinIO binary
      get_url:
        url: "{{ minio_download_url }}"
        dest: "{{ minio_install_dir }}/minio"
        mode: '0755'
        owner: root
        group: root

    - name: Create MinIO environment file
      template:
        src: templates/minio.env.j2
        dest: "{{ minio_config_dir }}/minio.env"
        owner: "{{ minio_service_user }}"
        group: "{{ minio_service_group }}"
        mode: '0600'

    - name: Create MinIO systemd service
      template:
        src: templates/minio.service.j2
        dest: /etc/systemd/system/minio.service
        owner: root
        group: root
        mode: '0644'
      notify: reload systemd

    - name: Enable and start MinIO service
      systemd:
        name: minio
        enabled: yes
        state: started
        daemon_reload: yes

    - name: Wait for MinIO to be ready
      wait_for:
        port: 9000
        delay: 5
        timeout: 60

    - name: Install MinIO Client (mc)
      get_url:
        url: "https://dl.min.io/client/mc/release/linux-amd64/mc"
        dest: "/usr/local/bin/mc"
        mode: '0755'

    - name: Configure mc alias for local MinIO
      become_user: "{{ ansible_user }}"
      shell: |
        /usr/local/bin/mc alias set local http://localhost:9000 {{ minio_root_user }} {{ minio_root_password }}
      args:
        creates: "/home/{{ ansible_user }}/.mc/config.json"

    - name: Create Terraform state bucket
      become_user: "{{ ansible_user }}"
      shell: |
        /usr/local/bin/mc mb local/{{ terraform_state_bucket }} --ignore-existing
      register: bucket_creation
      changed_when: "'Bucket created successfully' in bucket_creation.stdout"

    - name: Enable versioning on Terraform state bucket
      become_user: "{{ ansible_user }}"
      shell: |
        /usr/local/bin/mc version enable local/{{ terraform_state_bucket }}
      register: versioning_result
      changed_when: "'successfully enabled' in versioning_result.stdout"

    - name: Display MinIO access information
      debug:
        msg:
          - "MinIO Server is running!"
          - "API Endpoint: http://{{ ansible_host }}:9000"
          - "Console URL: http://{{ ansible_host }}:9001"
          - "Root User: {{ minio_root_user }}"
          - "Root Password: {{ minio_root_password }}"
          - "Terraform State Bucket: {{ terraform_state_bucket }}"
          - ""
          - "IMPORTANT: Change the root password in production!"
          - "Access the Console to create access keys for Terraform backend"

  handlers:
    - name: reload systemd
      systemd:
        daemon_reload: yes
