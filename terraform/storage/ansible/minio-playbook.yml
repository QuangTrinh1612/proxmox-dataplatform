---
- name: Install and Configure MinIO Server
  hosts: all
  become: yes
  vars:
    minio_version: "RELEASE.2024-10-13T13-34-11Z"
    minio_root_user: "minioadmin"
    minio_root_password: "minioadmin123"
    minio_data_dir: "/mnt/minio/data"
    minio_install_dir: "/usr/local/bin"
    minio_config_dir: "/etc/minio"
    terraform_bucket: "terraform-state"
    
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install required packages
      apt:
        name:
          - wget
          - curl
          - ca-certificates
        state: present

    - name: Create MinIO group
      group:
        name: minio-user
        state: present
        system: yes

    - name: Create MinIO user
      user:
        name: minio-user
        group: minio-user
        system: yes
        shell: /sbin/nologin
        home: "{{ minio_data_dir }}"
        create_home: no

    - name: Create MinIO directories
      file:
        path: "{{ item }}"
        state: directory
        owner: minio-user
        group: minio-user
        mode: '0750'
      loop:
        - "{{ minio_data_dir }}"
        - "{{ minio_config_dir }}"

    - name: Download MinIO server binary
      get_url:
        url: "https://dl.min.io/server/minio/release/linux-amd64/minio"
        dest: "{{ minio_install_dir }}/minio"
        mode: '0755'
        owner: root
        group: root

    - name: Download MinIO client (mc)
      get_url:
        url: "https://dl.min.io/client/mc/release/linux-amd64/mc"
        dest: "{{ minio_install_dir }}/mc"
        mode: '0755'
        owner: root
        group: root

    - name: Create MinIO environment file
      copy:
        dest: "{{ minio_config_dir }}/minio.env"
        content: |
          MINIO_ROOT_USER={{ minio_root_user }}
          MINIO_ROOT_PASSWORD={{ minio_root_password }}
          MINIO_VOLUMES={{ minio_data_dir }}
          MINIO_SERVER_URL=http://{{ ansible_default_ipv4.address }}:9000
          MINIO_BROWSER_REDIRECT_URL=http://{{ ansible_default_ipv4.address }}:9001
        mode: '0640'
        owner: minio-user
        group: minio-user

    - name: Create MinIO systemd service
      copy:
        dest: /etc/systemd/system/minio.service
        content: |
          [Unit]
          Description=MinIO Object Storage
          Documentation=https://min.io/docs/minio/linux/index.html
          Wants=network-online.target
          After=network-online.target
          AssertFileIsExecutable={{ minio_install_dir }}/minio

          [Service]
          Type=notify
          WorkingDirectory=/usr/local
          User=minio-user
          Group=minio-user
          ProtectProc=invisible
          EnvironmentFile={{ minio_config_dir }}/minio.env
          ExecStartPre=/bin/bash -c 'if [ -z "${MINIO_VOLUMES}" ]; then echo "Variable MINIO_VOLUMES not set in {{ minio_config_dir }}/minio.env"; exit 1; fi'
          ExecStart={{ minio_install_dir }}/minio server $MINIO_OPTS $MINIO_VOLUMES --console-address ":9001"
          Restart=always
          LimitNOFILE=65536
          TasksMax=infinity
          TimeoutStopSec=infinity
          SendSIGKILL=no

          [Install]
          WantedBy=multi-user.target
        mode: '0644'

    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes

    - name: Enable and start MinIO service
      systemd:
        name: minio
        enabled: yes
        state: started

    - name: Wait for MinIO to be ready
      wait_for:
        host: localhost
        port: 9000
        delay: 5
        timeout: 60

    - name: Configure mc alias
      command: >
        {{ minio_install_dir }}/mc alias set local 
        http://localhost:9000 
        {{ minio_root_user }} 
        {{ minio_root_password }}
      become: yes
      become_user: minio-user
      changed_when: false

    - name: Create Terraform state bucket
      command: >
        {{ minio_install_dir }}/mc mb local/{{ terraform_bucket }} --ignore-existing
      become: yes
      become_user: minio-user
      register: bucket_creation
      changed_when: "'Bucket created successfully' in bucket_creation.stdout"

    - name: Enable versioning on Terraform bucket
      command: >
        {{ minio_install_dir }}/mc version enable local/{{ terraform_bucket }}
      become: yes
      become_user: minio-user
      changed_when: false

    - name: Display MinIO credentials
      debug:
        msg:
          - "MinIO Server installed successfully!"
          - "API Endpoint: http://{{ ansible_default_ipv4.address }}:9000"
          - "Console URL: http://{{ ansible_default_ipv4.address }}:9001"
          - "Root User: {{ minio_root_user }}"
          - "Root Password: {{ minio_root_password }}"
          - "Terraform Bucket: {{ terraform_bucket }}"